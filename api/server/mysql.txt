CREATE DATABASE `files_gg_stable` CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

GRANT ALL PRIVILEGES ON `files_gg`.* TO '<user>'@'<host>' IDENTIFIED BY '<password>';

CREATE TABLE `mimetypes` (
    `mime` VARCHAR(100) NOT NULL PRIMARY KEY,
    `required_flags` INT(10) NOT NULL
);

CREATE TABLE `mimetypes_icons` (
	`type` VARCHAR(100) NOT NULL,
	`extension` VARCHAR(5) NOT NULL,
	`hash` VARCHAR(64) NOT NULL,
	PRIMARY KEY (`type`, `extension`)
);

CREATE TABLE `mimetypes_extensions` (
    `mime` VARCHAR(100) NOT NULL,
    `extension` VARCHAR(12) NOT NULL,
    FOREIGN KEY (`mime`) REFERENCES `mimetypes` (`mime`)
        ON UPDATE RESTRICT
        ON DELETE CASCADE,
    PRIMARY KEY (`mime`, `extension`)
);

CREATE TABLE `users` (
    `id` BIGINT(20) NOT NULL PRIMARY KEY,
    `email` VARCHAR(255) NOT NULL
);

CREATE TABLE `files` (
    `id` VARCHAR(10) NOT NULL,
    `folder` VARCHAR(10),
    `extension` VARCHAR(12),
    `user_id` BIGINT(20),
    `filename` VARCHAR(100) NOT NULL,
    `mimetype` VARCHAR(100) NOT NULL,
    `size` BIGINT(20) NOT NULL,
    `timestamp` INT(10) NOT NULL,
	`height` INT(10),
	`width` INT(10),
	`duration` INT(10),
    FOREIGN KEY (`user_id`) REFERENCES `users` (`id`)
        ON UPDATE RESTRICT
        ON DELETE CASCADE,
    FOREIGN KEY (`mimetype`) REFERENCES `mimetypes` (`mime`)
        ON UPDATE RESTRICT
        ON DELETE CASCADE,
    INDEX (`id`, `folder`),
    UNIQUE (`id`, `folder`)
);

CREATE TABLE `files_views` (
	`id` VARCHAR(10) NOT NULL,
	`folder` VARCHAR(10),
	`ip` VARBINARY(16),
	FOREIGN KEY (`id`) REFERENCES `files` (`id`),
		ON UPDATE RESTRICT
		ON DELETE CASCADE,
	FOREIGN KEY (`folder`) REFERENCES `files` (`folder`)
		ON UPDATE RESTRICT
		ON DELETE CASCADE,
	INDEX (`id`, `folder`),
	INDEX (`id`, `folder`, `ip`),
	UNIQUE (`id`, `folder`, `ip`)
);